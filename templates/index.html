<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>World Mosaic</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
<header>
  <h1>üåç World Mosaic</h1>
  <div class="controls">
    <a class="btn" href="{{ url_for('submit') }}">‚ûï Add Note</a>
    <form action="{{ url_for('reset') }}" method="POST" style="display:inline;">
    </form>
    <span>Total Notes: {{ notes|length }}</span>
    <select id="langSelect">
      <option value="">Original</option>
      <option value="en">English</option>
      <option value="es">Spanish</option>
      <option value="fr">French</option>
      <option value="de">German</option>
      <option value="ja">Japanese</option>
      <!-- Add more languages as needed -->
    </select>
  </div>
</header>

<div id="canvas-container">
  <div id="canvas">
    {% for note in notes %}
      <div class="tile" data-index="{{ loop.index0 }}">
        <div class="note-text">{{ note.text }}</div>
      </div>
    {% endfor %}
  </div>
</div>

<footer>
  <small>Use mouse wheel to zoom, drag to pan. Select a language to translate all notes.</small>
</footer>

<script>
const canvas = document.getElementById('canvas');
const container = document.getElementById('canvas-container');
let scale = 1, posX = 0, posY = 0;
let isPanning = false, startX, startY;

function updateTransform(){
  canvas.style.transform = `translate(calc(-50% + ${posX}px), calc(-50% + ${posY}px)) scale(${scale})`;
}

// Zoom
container.addEventListener('wheel', e => {
  e.preventDefault();
  scale += e.deltaY * -0.0015;
  scale = Math.min(Math.max(0.2, scale), 3);
  updateTransform();
});

// Pan
container.addEventListener('mousedown', e => {
  isPanning = true;
  startX = e.clientX - posX;
  startY = e.clientY - posY;
});
window.addEventListener('mouseup', () => isPanning = false);
window.addEventListener('mousemove', e => {
  if (!isPanning) return;
  posX = e.clientX - startX;
  posY = e.clientY - startY;
  updateTransform();
});

// Position tiles in golden-angle spiral
function positionTiles() {
  const tiles = document.querySelectorAll('.tile');
  const spacing = 220;
  tiles.forEach((tile, idx)=>{
    const angle = idx * 137.5 * (Math.PI/180);
    const radius = Math.sqrt(idx) * spacing;
    const x = Math.cos(angle) * radius;
    const y = Math.sin(angle) * radius;
    tile.style.position = 'absolute';
    tile.style.left = `${x}px`;
    tile.style.top = `${y}px`;
    tile.dataset.x = x;
    tile.dataset.y = y;
    if(!tile.dataset.original){
      tile.dataset.original = tile.querySelector('.note-text').textContent;
    }
  });
}
positionTiles();

// Focus on latest note
const tiles = document.querySelectorAll('.tile');
if(tiles.length){
    const last = tiles[tiles.length-1];
    posX = -parseFloat(last.dataset.x);
    posY = -parseFloat(last.dataset.y);
    updateTransform();
}

// Global language selector
document.getElementById('langSelect').addEventListener('change', async () => {
    const lang = document.getElementById('langSelect').value;
    const tiles = document.querySelectorAll('.tile');
    if(!lang){ // Original
        tiles.forEach(tile => tile.querySelector('.note-text').textContent = tile.dataset.original);
        return;
    }
    const indices = Array.from(tiles).map(t => t.dataset.index);
    try{
        const resp = await fetch("/translate", {
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body: JSON.stringify({indices, lang})
        });
        const data = await resp.json();
        tiles.forEach(tile => {
            const idx = tile.dataset.index;
            if(data[idx]){
                tile.querySelector('.note-text').textContent = data[idx];
                tile.dataset[lang] = data[idx];
            }
        });
    }catch(err){
        console.error("Translation failed", err);
        alert("Translation failed. Check console.");
    }
});
</script>
</body>
</html>
